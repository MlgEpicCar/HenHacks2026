{% extends "base.html" %}
{% block content %}

<h1>Gaming</h1>
<div style="display:flex; gap:2rem;">
    <div style="flex:1; min-width:300px;">
        <form method="POST" action="{{ url_for('add_friend_by_name') }}">
            <input type="text" name="username" placeholder="Enter friend's username" required>
            <button type="submit">Add Friend</button>
        </form>
    </div>
    <div style="flex:1; min-width:300px;">
        <h3>Play Rock Paper Scissors</h3>

        {% if user.friends %}
            <label>Select a friend:</label>
            <div style="margin-top:10px;">
                {% for friend in user.friends %}
                    <div style="margin-bottom:8px;">
                        <a href="{{ url_for('rps_challenge', friend_id=friend.id) }}">
                            <button type="button">
                                Play vs {{ friend.username }}
                            </button>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>You have no friends added yet.</p>
        {% endif %}
    </div>
</div>


<div id="game-board" style="width:100%;height:100vh;border:0px solid black;position:relative;">
    <!-- Player 1 -->
    <div id="player1-container" style="position:absolute; left:50px; top:300px; text-align:center;">
        <div id="player1" class="player" style="width:15vh;height:15vh;background-size:cover;background-position:center;"></div>
        <span id="player1-name" class="player-name" style="color:white; font-weight:bold;">Player1</span>
    </div>

    <!-- Player 2 -->
    <div id="player2-container" style="position:absolute; left:100px; top:300px; text-align:center;">
        <div id="player2" class="player" style="width:15vh;height:15vh;background-size:cover;background-position:center;"></div>
        <span id="player2-name" class="player-name" style="color:white; font-weight:bold;">Player2</span>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const keysDown = new Set();

// Current and target positions for smooth interpolation
let positions = {
    player1: { x: 50, y: 100 },
    player2: { x: 100, y: 100 }
};
let targetPositions = { ...positions };
let myPlayer = null;
const speed = 0.1; // interpolation speed (0.1-0.3 works well)

// Render function: updates DOM positions
function render() {
    for (let player in positions) {
        const container = document.getElementById(player + "-container");
        container.style.left = positions[player].x + "px";
        container.style.top = positions[player].y + "px";
    }
}

// Animation loop using requestAnimationFrame
function animate() {
    for (let player in positions) {
        // Linear interpolation towards target position
        positions[player].x += (targetPositions[player].x - positions[player].x) * speed;
        positions[player].y += (targetPositions[player].y - positions[player].y) * speed;
    }
    render();
    requestAnimationFrame(animate);
}
animate(); // start loop

// Handle initial assignment from server
socket.on("init", (data) => {
    myPlayer = data.player;
    targetPositions = data.positions;
});

// Handle updates from server
socket.on("update", (data) => {
    targetPositions = data; // server sends authoritative positions
});

// Send WASD moves to server
document.addEventListener("keydown", (e) => {
    if (!myPlayer) return; // don't send moves until server assigns player
    const key = e.key.toLowerCase();
    if (["w","a","s","d"].includes(key)) {
        socket.emit("move", { key: key });
    }
});

document.addEventListener("keyup", (e) => {
    const key = e.key.toLowerCase();
    keysDown.delete(key); // remove key from set
});

// Send moves at a constant interval
setInterval(() => {
    if (!myPlayer) return;
    if (keysDown.size > 0) {
        socket.emit("move", { keys: Array.from(keysDown) });
    }
}, 50); // 50ms = 20 updates/sec

let pfps = {}; // store each player's pfp
let usernames = {}; // store each player's username

socket.on("init", (data) => {
    myPlayer = data.player;
    targetPositions = data.positions;
    pfps = data.pfps || {};
    usernames = data.usernames || {}; // new: usernames mapping
    usernames = data.usernames || {};

    for (let player in pfps) {
        const el = document.getElementById(player);
        if (el) el.style.backgroundImage = `url('${pfps[player]}')`;

        const nameEl = document.getElementById(player + "-name");
        if (nameEl && usernames[player]) nameEl.textContent = usernames[player];
    }
});

</script>

{% endblock %}